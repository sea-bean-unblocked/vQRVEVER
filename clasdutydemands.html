<!-- shxyder -->
<!-- ultimate game stash file -->
<!-- file is huge, please make sure this is your only tab -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>As Duty Demands</title>
<style>
body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; }
#canvas { display: block; width: 100vw !important; height: 100vh !important; position: fixed; top: 0; left: 0; border: none; outline: none; object-fit: fill; }
#status { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; color: #fff; font-family: sans-serif; text-align: center; pointer-events: none; }
progress { width: 80vw; max-width: 400px; height: 20px; appearance: none; border-radius: 10px; overflow: hidden; }
progress::-webkit-progress-bar { background-color: #222; }
progress::-webkit-progress-value { background-color: #fff; }
</style>
<script src="https://cdn.jsdelivr.net/gh/gzuidhof/coi-serviceworker@latest/coi-serviceworker.min.js"></script>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="status">
<div id="status-text">Downloading As Duty Demands (79 parts)...</div>
<progress id="status-progress" value="0" max="100"></progress>
</div>
<script>
(function() {
'use strict';
const BASE_JS = "https://cdn.jsdelivr.net/gh/shayderrr/portsv4@06672782de36961983b66cdf43a8c415929ac992/web/";
const BASE_PCK = "https://cdn.jsdelivr.net/gh/shayderrr/portsv4@06672782de36961983b66cdf43a8c415929ac992/web/pck/";
const originalFetch = window.fetch;
const mergedData = {};
const pendingRequests = {};

window.fetch = function(url, ...args) {
    const u = url.toString();
    if (u.includes("As Duty Demands.pck") || u.includes("As%20Duty%20Demands.pck") || u.includes("As Duty Demands.wasm") || u.includes("As%20Duty%20Demands.wasm")) {
        const f = u.includes(".pck") ? "As Duty Demands.pck" : "As Duty Demands.wasm";
        if (mergedData[f]) return Promise.resolve(new Response(mergedData[f]));
        return new Promise((resolve) => {
            if (!pendingRequests[f]) pendingRequests[f] = [];
            pendingRequests[f].push(resolve);
        });
    }
    return originalFetch(url, ...args);
};

async function merge(name, baseUrl, start, end, pad) {
    const bufs = [];
    for (let i = start; i <= end; i++) {
        const p = pad ? i.toString().padStart(2, '0') : i;
        const url = baseUrl + encodeURIComponent(name + ".part" + p);
        const r = await originalFetch(url);
        if (!r.ok) throw new Error();
        bufs.push(await r.arrayBuffer());
        
        const totalParts = 81; 
        const currentPart = name.includes('.pck') ? i : 79 + i;
        document.getElementById('status-progress').value = (currentPart / totalParts) * 100;
        document.getElementById('status-text').innerText = `Loading ${name} (Part ${i}/${end})`;
    }
    const b = new Blob(bufs, { type: 'application/octet-stream' });
    mergedData[name] = b;
    if (pendingRequests[name]) {
        pendingRequests[name].forEach(res => res(new Response(b)));
        delete pendingRequests[name];
    }
}

async function init() {
    try {
        await merge("As Duty Demands.pck", BASE_PCK, 1, 79, true);
        await merge("As Duty Demands.wasm", BASE_JS, 1, 2, false);
        
        const s = document.createElement('script');
        s.src = BASE_JS + encodeURIComponent("As Duty Demands.js");
        s.onload = () => {
            const engine = new Engine({"args":[],"canvasResizePolicy":2,"emscriptenPoolSize":8,"ensureCrossOriginIsolationHeaders":true,"executable":"As Duty Demands","experimentalVK":false,"fileSizes":{"As Duty Demands.pck":1565896152,"As Duty Demands.wasm":35740641},"focusCanvas":true,"gdextensionLibs":[],"godotPoolSize":4});
            engine.startGame({
                onProgress: (c, t) => { if (t > 0) document.getElementById('status-progress').value = (c / t) * 100; }
            }).then(() => {
                document.getElementById('status').style.display = 'none';
                window.dispatchEvent(new Event('resize'));
            });
        };
        document.body.appendChild(s);
    } catch (e) {
        document.getElementById('status-text').innerText = "Load Failed - Check Connection";
    }
}
init();
})();
</script>
</body>
</html>